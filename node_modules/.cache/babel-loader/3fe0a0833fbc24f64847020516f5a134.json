{"ast":null,"code":"function _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  return _typeof = \"function\" == typeof Symbol && \"symbol\" == typeof Symbol.iterator ? function (obj) {\n    return typeof obj;\n  } : function (obj) {\n    return obj && \"function\" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n  }, _typeof(obj);\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  Object.defineProperty(Constructor, \"prototype\", {\n    writable: false\n  });\n  return Constructor;\n}\n\nfunction _get() {\n  if (typeof Reflect !== \"undefined\" && Reflect.get) {\n    _get = Reflect.get.bind();\n  } else {\n    _get = function _get(target, property, receiver) {\n      var base = _superPropBase(target, property);\n\n      if (!base) return;\n      var desc = Object.getOwnPropertyDescriptor(base, property);\n\n      if (desc.get) {\n        return desc.get.call(arguments.length < 3 ? target : receiver);\n      }\n\n      return desc.value;\n    };\n  }\n\n  return _get.apply(this, arguments);\n}\n\nfunction _superPropBase(object, property) {\n  while (!Object.prototype.hasOwnProperty.call(object, property)) {\n    object = _getPrototypeOf(object);\n    if (object === null) break;\n  }\n\n  return object;\n}\n\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function\");\n  }\n\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      writable: true,\n      configurable: true\n    }\n  });\n  Object.defineProperty(subClass, \"prototype\", {\n    writable: false\n  });\n  if (superClass) _setPrototypeOf(subClass, superClass);\n}\n\nfunction _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}\n\nfunction _createSuper(Derived) {\n  var hasNativeReflectConstruct = _isNativeReflectConstruct();\n\n  return function _createSuperInternal() {\n    var Super = _getPrototypeOf(Derived),\n        result;\n\n    if (hasNativeReflectConstruct) {\n      var NewTarget = _getPrototypeOf(this).constructor;\n\n      result = Reflect.construct(Super, arguments, NewTarget);\n    } else {\n      result = Super.apply(this, arguments);\n    }\n\n    return _possibleConstructorReturn(this, result);\n  };\n}\n\nfunction _possibleConstructorReturn(self, call) {\n  if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) {\n    return call;\n  } else if (call !== void 0) {\n    throw new TypeError(\"Derived constructors may only return object or undefined\");\n  }\n\n  return _assertThisInitialized(self);\n}\n\nfunction _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return self;\n}\n\nfunction _isNativeReflectConstruct() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n\n  try {\n    Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction _getPrototypeOf(o) {\n  _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf.bind() : function _getPrototypeOf(o) {\n    return o.__proto__ || Object.getPrototypeOf(o);\n  };\n  return _getPrototypeOf(o);\n}\n\nimport * as L from \"leaflet\";\nimport Controller from \"src/decidim/decidim_awesome/awesome_map/controllers/controller\";\nimport ProposalsFetcher from \"src/decidim/decidim_awesome/awesome_map/api/proposals_fetcher\";\nvar ProposalIcon = L.DivIcon.SVGIcon.DecidimIcon.extend({\n  options: {\n    fillColor: \"#ef604d\",\n    fillOpacity: 0.8,\n    strokeWidth: 1,\n    strokeOpcacity: 1\n  }\n});\n\nvar ProposalsController = /*#__PURE__*/function (_Controller) {\n  _inherits(ProposalsController, _Controller);\n\n  var _super = _createSuper(ProposalsController);\n\n  function ProposalsController(awesomeMap, component) {\n    var _this;\n\n    _classCallCheck(this, ProposalsController);\n\n    _this = _super.call(this, awesomeMap, component);\n    _this.templateId = \"marker-proposal-popup\";\n    _this.amendments = {};\n\n    _this.setFetcher(ProposalsFetcher);\n\n    return _this;\n  }\n\n  _createClass(ProposalsController, [{\n    key: \"addControls\",\n    value: function addControls() {\n      _get(_getPrototypeOf(ProposalsController.prototype), \"addControls\", this).call(this); // add control layer for amendments if any\n\n\n      if (this.awesomeMap.config.menu.amendments && this.component.amendments && !this.awesomeMap.layers.amendments) {\n        this.awesomeMap.layers.amendments = {\n          label: \"<span class=\\\"awesome_map-component\\\" id=\\\"awesome_map-amendments_\".concat(this.component.id, \"\\\" title=\\\"0\\\" data-layer=\\\"amendments\\\">\").concat(window.DecidimAwesome.texts.amendments, \"</span>\"),\n          group: new L.FeatureGroup.SubGroup(this.awesomeMap.cluster)\n        };\n        this.awesomeMap.controls.main.addOverlay(this.awesomeMap.layers.amendments.group, this.awesomeMap.layers.amendments.label);\n        this.awesomeMap.layers.amendments.group.addTo(this.awesomeMap.map);\n      }\n    }\n  }, {\n    key: \"loadNodes\",\n    value: function loadNodes() {\n      var _this2 = this; // for each proposal, create a marker with an associated popup\n\n\n      this.fetcher.onNode = function (proposal) {\n        var marker = new L.Marker([proposal.coordinates.latitude, proposal.coordinates.longitude], {\n          icon: _this2.createIcon(ProposalIcon, _this2.awesomeMap.getCategory(proposal.category).color),\n          title: proposal.title.translation\n        }); // Check if it has amendments, add it to a list\n        // also assign parent's proposal categories to it\n\n        if (proposal.amendments && proposal.amendments.length) {\n          proposal.amendments.forEach(function (amendment) {\n            _this2.amendments[amendment.emendation.id] = proposal;\n          });\n        } // console.log(\"new proposal\", proposal, \"marker\",  marker)\n\n\n        _this2.addMarker(marker, proposal);\n      };\n\n      this.fetcher.fetch();\n    }\n  }, {\n    key: \"_onFinished\",\n    value: function _onFinished() {\n      var _this3 = this;\n\n      var iterableAmendments = Object.entries(this.amendments);\n      this.awesomeMap.controls.updateStats(\"component_\".concat(this.component.id), this.allNodes.length - iterableAmendments.length);\n      this.awesomeMap.controls.updateStats(\"amendments_\".concat(this.component.id), iterableAmendments.length); // Process all amendments\n\n      iterableAmendments.forEach(function (amendment) {\n        var marker = _this3.allNodes.find(function (node) {\n          return node.id == amendment[0];\n        });\n\n        var parent = amendment[1]; // console.log(\"marker\", marker, \"parent proposal\", parent)\n        // add marker to amendments layers and remove it from proposals\n\n        if (marker) {\n          try {\n            marker.marker.removeFrom(_this3.controls.group);\n          } catch (e) {\n            console.error(\"error removeFrom marker\", marker, \"layer\", _this3.controls.group, e);\n          }\n\n          if (_this3.awesomeMap.config.menu.amendments) {\n            marker.marker.addTo(_this3.awesomeMap.layers.amendments.group); // mimic parent category (amendments doesn't have categories)\n\n            if (parent.category) {\n              marker.marker.setIcon(_this3.createIcon(ProposalIcon, _this3.awesomeMap.getCategory(parent.category).color));\n\n              _this3.addMarkerCategory(marker.marker, parent.category);\n            }\n          }\n        }\n      });\n      this.onFinished();\n    }\n  }]);\n\n  return ProposalsController;\n}(Controller);\n\nexport { ProposalsController as default };","map":{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAO,KAAKA,CAAZ,MAAmB,SAAnB;AACA,OAAOC,UAAP,MAAuB,gEAAvB;AACA,OAAOC,gBAAP,MAA6B,+DAA7B;AAEA,IAAMC,YAAY,GAAGH,CAAC,CAACI,OAAFJ,CAAUK,OAAVL,CAAkBM,WAAlBN,CAA8BO,MAA9BP,CAAqC;EACxDQ,OAAO,EAAE;IACPC,SAAS,EAAE,SADJ;IAEPC,WAAW,EAAE,GAFN;IAGPC,WAAW,EAAE,CAHN;IAIPC,cAAc,EAAE;EAJT;AAD+C,CAArCZ,CAArB;;IAQqBa,mB;;;;;EACnB,6BAAYC,UAAZ,EAAwBC,SAAxB,EAAmC;IAAA;;IAAAC;;IACjCC,0BAAMH,UAAN,EAAkBC,SAAlB;IACAE,MAAKC,UAAL,GAAkB,uBAAlB;IACAD,MAAKE,UAAL,GAAkB,EAAlB;;IACAF,MAAKG,UAAL,CAAgBlB,gBAAhB;;IAJiC;EAKlC;;;;WAED,uBAAc;MACZmB,qFADY,CAGZ;;;MACA,IAAI,KAAKP,UAAL,CAAgBQ,MAAhB,CAAuBC,IAAvB,CAA4BJ,UAA5B,IAA0C,KAAKJ,SAAL,CAAeI,UAAzD,IAAuE,CAAC,KAAKL,UAAL,CAAgBU,MAAhB,CAAuBL,UAAnG,EAA+G;QAC7G,KAAKL,UAAL,CAAgBU,MAAhB,CAAuBL,UAAvB,GAAoC;UAClCM,KAAK,8EAAoE,KAAKV,SAAL,CAAeW,EAAnF,sDAA4HC,MAAM,CAACC,cAAPD,CAAsBE,KAAtBF,CAA4BR,UAAxJ,YAD6B;UAElCW,KAAK,EAAE,IAAI9B,CAAC,CAAC+B,YAAF/B,CAAegC,QAAnB,CAA4B,KAAKlB,UAAL,CAAgBmB,OAA5C;QAF2B,CAApC;QAIA,KAAKnB,UAAL,CAAgBoB,QAAhB,CAAyBC,IAAzB,CAA8BC,UAA9B,CAAyC,KAAKtB,UAAL,CAAgBU,MAAhB,CAAuBL,UAAvB,CAAkCW,KAA3E,EAAkF,KAAKhB,UAAL,CAAgBU,MAAhB,CAAuBL,UAAvB,CAAkCM,KAApH;QACA,KAAKX,UAAL,CAAgBU,MAAhB,CAAuBL,UAAvB,CAAkCW,KAAlC,CAAwCO,KAAxC,CAA8C,KAAKvB,UAAL,CAAgBwB,GAA9D;MACD;IACF;;;WAED,qBAAY;MAAA,mBACV;;;MACA,KAAKC,OAAL,CAAaC,MAAb,GAAsB,UAACC,QAAD,EAAc;QAClC,IAAIC,MAAM,GAAG,IAAI1C,CAAC,CAAC2C,MAAN,CAAa,CAACF,QAAQ,CAACG,WAATH,CAAqBI,QAAtB,EAAgCJ,QAAQ,CAACG,WAATH,CAAqBK,SAArD,CAAb,EAA8E;UACzFC,IAAI,EAAEC,MAAI,CAACC,UAAL,CAAgB9C,YAAhB,EAA8B6C,MAAI,CAAClC,UAAL,CAAgBoC,WAAhB,CAA4BT,QAAQ,CAACU,QAArC,EAA+CC,KAA7E,CADmF;UAEzFC,KAAK,EAAEZ,QAAQ,CAACY,KAATZ,CAAea;QAFmE,CAA9E,CAAb,CADkC,CAMlC;QACA;;QACA,IAAIb,QAAQ,CAACtB,UAATsB,IAAuBA,QAAQ,CAACtB,UAATsB,CAAoBc,MAA/C,EAAuD;UACrDd,QAAQ,CAACtB,UAATsB,CAAoBe,OAApBf,CAA4B,UAACgB,SAAD,EAAe;YACzCT,MAAI,CAAC7B,UAAL,CAAgBsC,SAAS,CAACC,UAAVD,CAAqB/B,EAArC,IAA2Ce,QAA3C;UADF;QATgC,EAclC;;;QACAO,MAAI,CAACW,SAAL,CAAejB,MAAf,EAAuBD,QAAvB;MAfF;;MAkBA,KAAKF,OAAL,CAAaqB,KAAb;IACD;;;WAED,uBAAc;MAAA;;MACZ,IAAMC,kBAAkB,GAAGC,MAAM,CAACC,OAAPD,CAAe,KAAK3C,UAApB2C,CAA3B;MACA,KAAKhD,UAAL,CAAgBoB,QAAhB,CAAyB8B,WAAzB,qBAAkD,KAAKjD,SAAL,CAAeW,EAAjE,GAAuE,KAAKuC,QAAL,CAAcV,MAAd,GAAuBM,kBAAkB,CAACN,MAAjH;MACA,KAAKzC,UAAL,CAAgBoB,QAAhB,CAAyB8B,WAAzB,sBAAmD,KAAKjD,SAAL,CAAeW,EAAlE,GAAwEmC,kBAAkB,CAACN,MAA3F,EAHY,CAKZ;;MACAM,kBAAkB,CAACL,OAAnBK,CAA2B,UAACJ,SAAD,EAAe;QACxC,IAAMf,MAAM,GAAGwB,MAAI,CAACD,QAAL,CAAcE,IAAd,CAAmB,UAACC,IAAD;UAAA,OAAUA,IAAI,CAAC1C,EAAL0C,IAAWX,SAAS,CAAC,CAAD,CAA9B;QAAnB,EAAf;;QACA,IAAMY,MAAM,GAAGZ,SAAS,CAAC,CAAD,CAAxB,CAFwC,CAGxC;QACA;;QACA,IAAIf,MAAJ,EAAY;UACV,IAAI;YACFA,MAAM,CAACA,MAAPA,CAAc4B,UAAd5B,CAAyBwB,MAAI,CAAChC,QAAL,CAAcJ,KAAvCY;UADF,EAEE,OAAO6B,CAAP,EAAU;YACVC,OAAO,CAACC,KAARD,CAAc,yBAAdA,EAAyC9B,MAAzC8B,EAAiD,OAAjDA,EAA0DN,MAAI,CAAChC,QAAL,CAAcJ,KAAxE0C,EAAgFD,CAAhFC;UACD;;UACD,IAAIN,MAAI,CAACpD,UAAL,CAAgBQ,MAAhB,CAAuBC,IAAvB,CAA4BJ,UAAhC,EAA4C;YAC1CuB,MAAM,CAACA,MAAPA,CAAcL,KAAdK,CAAoBwB,MAAI,CAACpD,UAAL,CAAgBU,MAAhB,CAAuBL,UAAvB,CAAkCW,KAAtDY,EAD0C,CAE1C;;YACA,IAAI2B,MAAM,CAAClB,QAAX,EAAqB;cACnBT,MAAM,CAACA,MAAPA,CAAcgC,OAAdhC,CAAsBwB,MAAI,CAACjB,UAAL,CAAgB9C,YAAhB,EAA8B+D,MAAI,CAACpD,UAAL,CAAgBoC,WAAhB,CAA4BmB,MAAM,CAAClB,QAAnC,EAA6CC,KAA3E,CAAtBV;;cACAwB,MAAI,CAACS,iBAAL,CAAuBjC,MAAM,CAACA,MAA9B,EAAsC2B,MAAM,CAAClB,QAA7C;YACD;UACF;QACF;MAnBH;MAsBA,KAAKyB,UAAL;IACD;;;;EA1E8C3E,U;;SAA5BY,mB","names":["L","Controller","ProposalsFetcher","ProposalIcon","DivIcon","SVGIcon","DecidimIcon","extend","options","fillColor","fillOpacity","strokeWidth","strokeOpcacity","ProposalsController","awesomeMap","component","_classCallCheck","_this","templateId","amendments","setFetcher","_get","config","menu","layers","label","id","window","DecidimAwesome","texts","group","FeatureGroup","SubGroup","cluster","controls","main","addOverlay","addTo","map","fetcher","onNode","proposal","marker","Marker","coordinates","latitude","longitude","icon","_this2","createIcon","getCategory","category","color","title","translation","length","forEach","amendment","emendation","addMarker","fetch","iterableAmendments","Object","entries","updateStats","allNodes","_this3","find","node","parent","removeFrom","e","console","error","setIcon","addMarkerCategory","onFinished"],"sources":["/home/injam/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/decidim-decidim_awesome-0.8.3/app/packs/src/decidim/decidim_awesome/awesome_map/controllers/proposals_controller.js"],"sourcesContent":["import * as L from \"leaflet\";\nimport Controller from \"src/decidim/decidim_awesome/awesome_map/controllers/controller\";\nimport ProposalsFetcher from \"src/decidim/decidim_awesome/awesome_map/api/proposals_fetcher\";\n\nconst ProposalIcon = L.DivIcon.SVGIcon.DecidimIcon.extend({\n  options: {\n    fillColor: \"#ef604d\",\n    fillOpacity: 0.8,\n    strokeWidth: 1,\n    strokeOpcacity: 1\n  }\n});\nexport default class ProposalsController extends Controller {\n  constructor(awesomeMap, component) {\n    super(awesomeMap, component)\n    this.templateId = \"marker-proposal-popup\";\n    this.amendments = {};\n    this.setFetcher(ProposalsFetcher);\n  }\n\n  addControls() {\n    super.addControls();\n\n    // add control layer for amendments if any\n    if (this.awesomeMap.config.menu.amendments && this.component.amendments && !this.awesomeMap.layers.amendments) {\n      this.awesomeMap.layers.amendments = {\n        label: `<span class=\"awesome_map-component\" id=\"awesome_map-amendments_${this.component.id}\" title=\"0\" data-layer=\"amendments\">${window.DecidimAwesome.texts.amendments}</span>`,\n        group: new L.FeatureGroup.SubGroup(this.awesomeMap.cluster)\n      }\n      this.awesomeMap.controls.main.addOverlay(this.awesomeMap.layers.amendments.group, this.awesomeMap.layers.amendments.label);\n      this.awesomeMap.layers.amendments.group.addTo(this.awesomeMap.map);\n    }\n  }\n\n  loadNodes() {\n    // for each proposal, create a marker with an associated popup\n    this.fetcher.onNode = (proposal) => {\n      let marker = new L.Marker([proposal.coordinates.latitude, proposal.coordinates.longitude], {\n        icon: this.createIcon(ProposalIcon, this.awesomeMap.getCategory(proposal.category).color),\n        title: proposal.title.translation\n      });\n\n      // Check if it has amendments, add it to a list\n      // also assign parent's proposal categories to it\n      if (proposal.amendments && proposal.amendments.length) {\n        proposal.amendments.forEach((amendment) => {\n          this.amendments[amendment.emendation.id] = proposal;\n        });\n      }\n\n      // console.log(\"new proposal\", proposal, \"marker\",  marker)\n      this.addMarker(marker, proposal);\n    };\n\n    this.fetcher.fetch();\n  }\n\n  _onFinished() {\n    const iterableAmendments = Object.entries(this.amendments);\n    this.awesomeMap.controls.updateStats(`component_${this.component.id}`, this.allNodes.length - iterableAmendments.length);\n    this.awesomeMap.controls.updateStats(`amendments_${this.component.id}`, iterableAmendments.length);\n\n    // Process all amendments\n    iterableAmendments.forEach((amendment) => {\n      const marker = this.allNodes.find((node) => node.id == amendment[0]);\n      const parent = amendment[1];\n      // console.log(\"marker\", marker, \"parent proposal\", parent)\n      // add marker to amendments layers and remove it from proposals\n      if (marker) {\n        try { \n          marker.marker.removeFrom(this.controls.group) \n        } catch (e) { \n          console.error(\"error removeFrom marker\", marker, \"layer\", this.controls.group,  e);\n        }\n        if (this.awesomeMap.config.menu.amendments) {\n          marker.marker.addTo(this.awesomeMap.layers.amendments.group);\n          // mimic parent category (amendments doesn't have categories)\n          if (parent.category) {\n            marker.marker.setIcon(this.createIcon(ProposalIcon, this.awesomeMap.getCategory(parent.category).color));\n            this.addMarkerCategory(marker.marker, parent.category)\n          }\n        }\n      }\n    });\n\n    this.onFinished();\n  }\n}\n"]},"metadata":{},"sourceType":"module"}